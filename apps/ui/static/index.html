<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finance MCP Agent UI</title>
  <style>
    :root {
      --bg: #f3f6f7;
      --ink: #111827;
      --muted: #5b6777;
      --line: #dbe2ea;
      --card: #ffffff;
      --brand: #0f766e;
      --brand-2: #14b8a6;
      --accent: #f59e0b;
      --ok: #166534;
      --bad: #b91c1c;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      color: var(--ink);
      font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 10% 0%, #d8f5ea 0, transparent 35%),
        radial-gradient(circle at 95% 0%, #e2efff 0, transparent 30%),
        var(--bg);
    }

    .wrap {
      max-width: 1050px;
      margin: 0 auto;
      padding: 24px 16px 32px;
    }

    .header {
      margin-bottom: 12px;
    }

    .header h1 {
      margin: 0;
      font-size: 1.65rem;
      font-family: "Space Grotesk", "IBM Plex Sans", sans-serif;
      letter-spacing: 0.2px;
    }

    .header p {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 16px;
      margin-top: 14px;
      box-shadow: 0 8px 28px rgba(15, 23, 42, 0.05);
    }

    .panel h2 {
      margin: 0 0 10px;
      font-size: 1.1rem;
      font-family: "Space Grotesk", "IBM Plex Sans", sans-serif;
    }

    .fields {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    label {
      display: block;
      font-size: 0.85rem;
      color: #334155;
      margin-bottom: 6px;
      font-weight: 600;
    }

    input {
      width: 100%;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 10px;
      font-size: 0.95rem;
      font-family: inherit;
      background: #fff;
    }

    input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.12);
    }

    .line {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .line input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 11px 14px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
    }

    .btn.primary {
      color: #fff;
      background: linear-gradient(120deg, var(--brand), var(--brand-2));
    }

    .btn.secondary {
      color: #0f172a;
      background: #e2e8f0;
      font-weight: 600;
    }

    .btn:disabled {
      opacity: 0.65;
      cursor: wait;
    }

    .status {
      display: none;
      font-weight: 600;
      margin-top: 8px;
      font-size: 0.92rem;
    }

    .status.ok { color: var(--ok); display: block; }
    .status.err { color: var(--bad); display: block; }
    .status.muted { color: var(--muted); display: block; }

    .status.loading::after {
      content: " ...";
      animation: pulse 1.1s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.2; }
      50% { opacity: 1; }
      100% { opacity: 0.2; }
    }

    .hidden { display: none; }

    .metrics {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    .metric {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      background: #f8fafc;
    }

    .metric .k {
      color: #475569;
      font-size: 0.84rem;
      margin-bottom: 6px;
    }

    .metric .v {
      font-size: 1.45rem;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .metric .sub {
      margin-top: 4px;
      color: #64748b;
      font-size: 0.82rem;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 700;
    }

    .badge.ok {
      color: #065f46;
      background: #d1fae5;
      border: 1px solid #a7f3d0;
    }

    .badge.bad {
      color: #7f1d1d;
      background: #fee2e2;
      border: 1px solid #fecaca;
    }

    .overview-meta {
      margin-top: 10px;
      color: #64748b;
      font-size: 0.88rem;
    }

    .summary-head {
      color: #475569;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .snapshot {
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #f8fafc;
      padding: 12px;
      margin-bottom: 10px;
      line-height: 1.45;
      font-size: 0.94rem;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .block {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px;
      background: #fcfcfd;
      min-height: 170px;
    }

    .block h3 {
      margin: 0 0 8px;
      font-size: 0.95rem;
      font-family: "Space Grotesk", "IBM Plex Sans", sans-serif;
    }

    ul {
      margin: 0;
      padding-left: 18px;
    }

    li {
      margin-bottom: 7px;
      line-height: 1.36;
      font-size: 0.92rem;
    }

    .recommendation-cards {
      display: grid;
      gap: 8px;
    }

    .recommendation-card {
      border: 1px solid #e5e7eb;
      border-radius: 9px;
      background: #ffffff;
      padding: 8px;
    }

    .recommendation-card h4 {
      margin: 0 0 6px;
      font-size: 0.9rem;
      font-family: "Space Grotesk", "IBM Plex Sans", sans-serif;
    }

    .meta {
      font-size: 0.84rem;
      color: #334155;
      margin-bottom: 3px;
    }

    @media (max-width: 980px) {
      .fields { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .metrics { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .summary-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 620px) {
      .fields { grid-template-columns: 1fr; }
      .metrics { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="header">
      <h1>Finance MCP + Agent</h1>
      <p>Clean monthly finance summary with clear bilingual recommendations.</p>
    </section>

    <section class="panel" id="runCard">
      <h2> Run Report / הפעלת דוח</h2>
      <div class="fields">
        <div>
          <label for="uploadFile">Upload file / העלאת קובץ</label>
          <input id="uploadFile" type="file" accept=".csv,.xlsx,.xls" />
        </div>
        <div>
          <label for="month">Month / חודש</label>
          <input id="month" placeholder="YYYY-MM (optional)" />
        </div>
        <div>
          <label for="recommendations">Recommendations / כמות המלצות</label>
          <input id="recommendations" type="number" min="3" max="7" value="3" />
        </div>
        <div>
          <label for="llmModel">LLM Model</label>
          <input id="llmModel" value="gpt-4o-mini" />
        </div>
      </div>

      <div class="line">
        <input id="useLlm" type="checkbox" checked />
        <label for="useLlm" style="margin:0;">Use LLM summary / סיכום מבוסס AI</label>
      </div>

      <div class="line">
        <button id="runBtn" class="btn primary">Generate Report</button>
        <button id="latestBtn" class="btn secondary" type="button">Use Latest Month</button>
      </div>

      <p id="status" class="status"></p>
    </section>

    <section class="panel hidden" id="overviewCard">
      <h2> Financial Overview / תמונת מצב</h2>
      <div class="metrics">
        <div class="metric">
          <div class="k">Core Spent / הוצאה ליבה</div>
          <div id="spent" class="v">-</div>
        </div>
        <div class="metric">
          <div class="k">Income / הכנסות</div>
          <div id="income" class="v">-</div>
        </div>
        <div class="metric">
          <div class="k">Total Expenses / סך הוצאות</div>
          <div id="totalExpenses" class="v">-</div>
          <div class="sub">All debits / כל החיובים</div>
        </div>
        <div class="metric">
          <div class="k">Result (Income - Expenses) / תוצאה</div>
          <div id="net" class="v">-</div>
          <div id="balanceState" class="badge">-</div>
        </div>
      </div>
      <div class="overview-meta" id="overviewMeta"></div>
    </section>

    <section class="panel hidden" id="summaryCard">
      <h2> Monthly Summary / סיכום חודשי</h2>
      <div id="summaryHead" class="summary-head"></div>
      <div id="summarySnapshot" class="snapshot"></div>

      <div class="summary-grid">
        <div class="block">
          <h3>Top Merchants / בתי עסק מובילים</h3>
          <ul id="topMerchants"></ul>
        </div>

        <div class="block">
          <h3>Recommendations / המלצות</h3>
          <div id="suggestions" class="recommendation-cards"></div>
        </div>

        <div class="block">
          <h3>Anomalies / חריגות</h3>
          <ul id="anomalies"></ul>
        </div>
      </div>
    </section>
  </div>

  <script>
    const runBtn = document.getElementById('runBtn');
    const latestBtn = document.getElementById('latestBtn');
    const statusEl = document.getElementById('status');

    const overviewCard = document.getElementById('overviewCard');
    const summaryCard = document.getElementById('summaryCard');

    const fmt = (n) => Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function setStatus(message, kind = 'muted', loading = false) {
      statusEl.className = `status ${kind}${loading ? ' loading' : ''}`;
      statusEl.textContent = message;
    }

    async function runReport() {
      const fileInput = document.getElementById('uploadFile');
      const selectedFile = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

      if (!selectedFile) {
        setStatus('Please upload a CSV or Excel file first.', 'err', false);
        return;
      }

      const payload = {
        month: document.getElementById('month').value.trim(),
        recommendations: Number(document.getElementById('recommendations').value || 3),
        use_llm: document.getElementById('useLlm').checked,
        llm_model: document.getElementById('llmModel').value.trim() || 'gpt-4o-mini'
      };

      runBtn.disabled = true;
      latestBtn.disabled = true;
      setStatus('Running pipeline', 'muted', true);

      try {
        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('month', payload.month);
        formData.append('recommendations', String(payload.recommendations));
        formData.append('use_llm', String(payload.use_llm));
        formData.append('llm_model', payload.llm_model);

        const res = await fetch('/api/run-report', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || 'Request failed');
        }

        setStatus('Report generated successfully.', 'ok', false);
        renderResults(data);
      } catch (err) {
        setStatus(err.message || 'Unexpected error', 'err', false);
      } finally {
        runBtn.disabled = false;
        latestBtn.disabled = false;
      }
    }

    function renderResults(data) {
      overviewCard.classList.remove('hidden');
      summaryCard.classList.remove('hidden');

      const report = data.monthly_report || {};
      const suggestions = data.budget_suggestions_ui || data.budget_suggestions || { suggestions: [], anomalies: [] };
      const merchants = data.top_merchants || { top_merchants: [] };

      const spentAdjusted = report.total_expenses_core ?? report.total_spent_adjusted ?? report.total_spent ?? 0;
      const totalExpenses = report.total_spent_raw ?? report.total_spent ?? 0;
      const income = report.total_income_all ?? report.total_income ?? 0;
      const netAdjusted = Number(income) - Number(totalExpenses);
      const netRaw = report.net_balance ?? 0;

      document.getElementById('spent').textContent = fmt(spentAdjusted);
      document.getElementById('income').textContent = fmt(income);
      document.getElementById('totalExpenses').textContent = fmt(totalExpenses);
      document.getElementById('net').textContent = fmt(netAdjusted);

      const badge = document.getElementById('balanceState');
      if (netAdjusted > 0) {
        badge.className = 'badge ok';
        badge.textContent = 'Profit / רווח';
      } else if (netAdjusted < 0) {
        badge.className = 'badge bad';
        badge.textContent = 'Loss / הפסד';
      } else {
        badge.className = 'badge bad';
        badge.textContent = 'Break-even / איזון';
      }

      document.getElementById('overviewMeta').textContent =
        `formula: income (${fmt(income)}) - total expenses (${fmt(totalExpenses)}) = ${fmt(netAdjusted)} | core expenses=${fmt(spentAdjusted)} | raw net=${fmt(netRaw)} | report=${data.report_path}`;

      const selectedMonth = data.month || 'n/a';
      const requestedMonth = data.month_requested || 'auto-latest';
      const range = data.data_range
        ? `${data.data_range.first_date} .. ${data.data_range.last_date}`
        : 'n/a';
      const currency = report.currency || '-';

      document.getElementById('summaryHead').textContent =
        `dataset=${data.dataset_id} | selected=${selectedMonth} | requested=${requestedMonth} | range=${range} | currency=${currency}`;

      document.getElementById('summarySnapshot').innerHTML = buildSummarySnapshot({
        report,
        selectedMonth,
        range,
        top: merchants.top_merchants || []
      });

      const merchantsEl = document.getElementById('topMerchants');
      merchantsEl.innerHTML = '';
      (merchants.top_merchants || []).forEach((m) => {
        const li = document.createElement('li');
        const name = (m.merchant_en && m.merchant_en !== m.merchant)
          ? `${m.merchant_en} (${m.merchant})`
          : m.merchant;
        li.textContent = `${name}: ${fmt(m.total_spend)} (${m.transactions_count} tx)`;
        merchantsEl.appendChild(li);
      });
      if (!merchantsEl.children.length) {
        const li = document.createElement('li');
        li.textContent = 'No merchant data.';
        merchantsEl.appendChild(li);
      }

      const suggEl = document.getElementById('suggestions');
      suggEl.innerHTML = '';
      (suggestions.suggestions || []).forEach((s, idx) => {
        const card = document.createElement('div');
        card.className = 'recommendation-card';

        const title = document.createElement('h4');
        title.textContent = `${idx + 1}. ${formatSuggestionTitle(s)}`;

        const impact = document.createElement('div');
        impact.className = 'meta';
        impact.textContent = `Impact / השפעה: ${fmt(s.estimated_monthly_impact || 0)} ${currency}`;

        const reason = document.createElement('div');
        reason.className = 'meta';
        reason.textContent = `Reason / סיבה: ${s.reason || '-'}`;

        const action = document.createElement('div');
        action.className = 'meta';
        action.textContent = `Action / פעולה: ${(s.action_steps && s.action_steps[0]) ? s.action_steps[0] : '-'}`;

        card.appendChild(title);
        card.appendChild(impact);
        card.appendChild(reason);
        card.appendChild(action);
        suggEl.appendChild(card);
      });
      if (!suggEl.children.length) {
        const empty = document.createElement('div');
        empty.className = 'meta';
        empty.textContent = 'No suggestions available.';
        suggEl.appendChild(empty);
      }

      const anomaliesEl = document.getElementById('anomalies');
      anomaliesEl.innerHTML = '';
      if (!suggestions.anomalies || !suggestions.anomalies.length) {
        const li = document.createElement('li');
        li.textContent = 'No anomalies detected.';
        anomaliesEl.appendChild(li);
      } else {
        suggestions.anomalies.forEach((a) => {
          const li = document.createElement('li');
          li.textContent = `[${a.severity}] ${a.message}`;
          anomaliesEl.appendChild(li);
        });
      }
    }

    function buildSummarySnapshot({ report, selectedMonth, range, top }) {
      const topText = top.slice(0, 3).map((m) => {
        const name = (m.merchant_en && m.merchant_en !== m.merchant)
          ? `${m.merchant_en} (${m.merchant})`
          : m.merchant;
        return `${name}: ${fmt(m.total_spend)}`;
      }).join(' | ') || 'No top merchants';

      const lines = [
        `<strong>Month / חודש:</strong> ${selectedMonth}`,
        `<strong>Data Range / טווח נתונים:</strong> ${range}`,
        `<strong>Core Spent / הוצאה ליבה:</strong> ${fmt(report.total_expenses_core ?? report.total_spent_adjusted ?? report.total_spent ?? 0)}`,
        `<strong>Income / הכנסות:</strong> ${fmt(report.total_income_all ?? report.total_income ?? 0)}`,
        `<strong>Total Expenses / סך הוצאות:</strong> ${fmt(report.total_spent_raw ?? report.total_spent ?? 0)}`,
        `<strong>Result (Income - Expenses) / תוצאה:</strong> ${fmt((Number(report.total_income_all ?? report.total_income ?? 0) - Number(report.total_spent_raw ?? report.total_spent ?? 0)))}`,
        `<strong>Top Focus / מוקד מוביל:</strong> ${topText}`
      ];

      return lines.map((line) => `<div style="margin-bottom:4px;">${line}</div>`).join('');
    }

    function formatSuggestionTitle(s) {
      const category = categoryLabel(s.category);
      if (s.title && !String(s.title).startsWith('Reduce ')) {
        return `${s.title} (${category})`;
      }
      return `${category} - reduce by 10% / להפחית ב-10%`;
    }

    function categoryLabel(cat) {
      const map = {
        card_payment: 'Card Payments / תשלומי אשראי',
        transfers: 'Transfers / העברות',
        cash_withdrawal: 'Cash Withdrawal / משיכת מזומן',
        loan_principal: 'Loan Principal / קרן הלוואה',
        loan_interest: 'Loan Interest / ריבית הלוואה',
        savings_deposit: 'Savings Deposit / פקדונות',
        subscriptions: 'Subscriptions / מנויים',
        transport: 'Transport / תחבורה',
        other: 'Other / אחר'
      };
      return map[cat] || `${cat || 'other'} / ${cat || 'אחר'}`;
    }

    runBtn.addEventListener('click', runReport);
    latestBtn.addEventListener('click', () => {
      const monthInput = document.getElementById('month');
      monthInput.value = '';
      setStatus('Month cleared. Next run uses latest month from file.', 'ok', false);
    });
  </script>
</body>
</html>
